MACRO_CHECK_SHOULD_BUILD(udt3 Threads_FOUND)

IF(udt3_SHOULD_BUILD)

  STRING(TOUPPER "${CMAKE_SYSTEM_NAME}" UPPER_SYSTEM_NAME)

  IF(WIN32)
    SET(udt3_DEFINITIONS "-DWIN32")
    IF(MINGW)
      SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -D__MINGW__")
    ENDIF(MINGW)
  ELSEIF(UPPER_SYSTEM_NAME STREQUAL "UNIX")
    SET(udt3_DEFINITIONS "-DUNIX")
  ELSEIF(UPPER_SYSTEM_NAME STREQUAL "LINUX")
    SET(udt3_DEFINITIONS "-DLINUX")
  ELSE(WIN32)
    SET(udt3_DEFINITIONS)
  ENDIF(WIN32)

  IF(CMAKE_SYSTEM_PROCESSOR MATCHES "i[0-9]?86")
    SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DIA32")
  ELSEIF(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64")
    SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DAMD64")
  ELSEIF(CMAKE_SYSTEM_PROCESSOR MATCHES "powerpc")
    SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -mcpu=powerpc")
  ELSEIF(CMAKE_SYSTEM_PROCESSOR MATCHES "sparc")
    SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -mcpu=sparc")
  ENDIF(CMAKE_SYSTEM_PROCESSOR MATCHES "i[0-9]?86")

  INCLUDE(TestBigEndian)
  TEST_BIG_ENDIAN(ARCH_IS_BIG_ENDIAN)
  IF(DEFINED ARCH_IS_BIG_ENDIAN)
    IF(ARCH_IS_BIG_ENDIAN)
      SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DARCH_IS_BIG_ENDIAN=1")
    ELSE(ARCH_IS_BIG_ENDIAN)
      SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DARCH_IS_BIG_ENDIAN=0")
    ENDIF(ARCH_IS_BIG_ENDIAN)
  ENDIF(DEFINED ARCH_IS_BIG_ENDIAN)

  SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DNO_BUSY_WAITING")

  MESSAGE(STATUS "udt3_DEFINITIONS=${udt3_DEFINITIONS}")
  ADD_DEFINITIONS("${udt3_DEFINITIONS}")

  SET(udt3_SRC
    api.cpp
    buffer.cpp
    ccc.cpp
    channel.cpp
    common.cpp
    core.cpp
    list.cpp
    packet.cpp
    window.cpp
    )

  ADD_LIBRARY(udt3 ${udt3_SRC})
  TARGET_LINK_LIBRARIES(udt3 ${CMAKE_THREAD_LIBS_INIT})
  #INSTALL(TARGETS udt3 DESTINATION lib)
  INSTALL(TARGETS udt3    
      LIBRARY DESTINATION lib 
      COMPONENT "izenelib_libraries")

  # we know the warnings, it's ok to alias void* as char*
  IF(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_COMPILER_IS_GNUC)
    SET_TARGET_PROPERTIES(udt3 PROPERTIES COMPILE_FLAGS
      "-Wno-strict-aliasing"
      )
  ENDIF(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_COMPILER_IS_GNUC)

ENDIF(udt3_SHOULD_BUILD)
