IF(WIN32)
  SET(udt3_DEFINITIONS "-DWIN32")
  IF(MINGW)
    SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -D__MINGW__")
  ENDIF(MINGW)
ELSEIF(CMAKE_SYSTEM_NAME STREQUAL "UNIX")
  SET(udt3_DEFINITIONS "-DUNIX")
ELSEIF(CMAKE_SYSTEM_NAME STREQUAL "LINUX")
  SET(udt3_DEFINITIONS "-DLINUX")
ELSE(WIN32)
  SET(udt3_DEFINITIONS)
ENDIF(WIN32)

IF(CMAKE_SYSTEM_PROCESSOR MATCHES "i[0-9]?86")
  SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DIA32")
ELSEIF(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64")
  SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DAMD64")
ELSEIF(CMAKE_SYSTEM_PROCESSOR MATCHES "powerpc")
  SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -mcpu=powerpc")
ELSEIF(CMAKE_SYSTEM_PROCESSOR MATCHES "sparc")
  SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -mcpu=sparc")
ENDIF(CMAKE_SYSTEM_PROCESSOR MATCHES "i[0-9]?86")

INCLUDE(TestBigEndian)
TEST_BIG_ENDIAN(ARCH_IS_BIG_ENDIAN)
IF(DEFINED ARCH_IS_BIG_ENDIAN)
  IF(ARCH_IS_BIG_ENDIAN)
    SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DARCH_IS_BIG_ENDIAN=1")
  ELSE(ARCH_IS_BIG_ENDIAN)
    SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DARCH_IS_BIG_ENDIAN=0")
  ENDIF(ARCH_IS_BIG_ENDIAN)
ENDIF(DEFINED ARCH_IS_BIG_ENDIAN)
  
SET(udt3_DEFINITIONS "${udt3_DEFINITIONS} -DNO_BUSY_WAITING")

MESSAGE(STATUS "udt3_DEFINITIONS=${udt3_DEFINITIONS}")
ADD_DEFINITIONS("${udt3_DEFINITIONS}")

SET_PROPERTY(GLOBAL APPEND PROPERTY BUILD_COMPONENTS udt3)

FILE(GLOB_RECURSE udt3_SRC
  api.cpp
  buffer.cpp
  ccc.cpp
  channel.cpp
  common.cpp
  core.cpp
  list.cpp
  packet.cpp
  window.cpp
  )

ADD_LIBRARY(udt3_shared SHARED ${udt3_SRC})
SET_TARGET_PROPERTIES(udt3_shared PROPERTIES
  OUTPUT_NAME "udt3"
  CLEAN_DIRECT_OUTPUT 1
  VERSION ${PROJECT_VERSION}
  )

ADD_LIBRARY(udt3_static STATIC ${udt3_SRC})
SET_TARGET_PROPERTIES(udt3_static PROPERTIES
  OUTPUT_NAME "udt3"
  CLEAN_DIRECT_OUTPUT 1
  )

# we know the warnings, it's ok to alias void* as char*
IF(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_COMPILER_IS_GNUC)
  SET_TARGET_PROPERTIES(udt_static PROPERTIES
    COMPILE_FLAGS "-Wno-strict-aliasing"
    )
  SET_TARGET_PROPERTIES(udt_shared PROPERTIES
    COMPILE_FLAGS "-Wno-strict-aliasing"
    )
ENDIF(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_COMPILER_IS_GNUC)

INSTALL(TARGETS udt3_static udt3_shared
  EXPORT udt3
  ARCHIVE DESTINATION ${VERSION_INSTALL_PREFIX}/lib
  LIBRARY DESTINATION shared)

INSTALL(EXPORT udt3
  DESTINATION ${VERSION_INSTALL_PREFIX}/cmake)
